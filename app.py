from flask import url_for, Flask, request,render_template
import google.generativeai as genai
import json
import os


API_KEY='AIzaSyD6V7UQ9_AgMhiH76t2o9td3bAPXFfrhb0'
genai.configure(api_key=API_KEY)

generation_config = {
  "temperature": 1,
  "top_p": 1,
  "top_k": 1,
  "max_output_tokens": 9000,
  
}


safety_settings = [
  {
    "category": "HARM_CATEGORY_HARASSMENT",
    "threshold": "BLOCK_MEDIUM_AND_ABOVE"
  },
  {
    "category": "HARM_CATEGORY_HATE_SPEECH",
    "threshold": "BLOCK_MEDIUM_AND_ABOVE"
  },
  {
    "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
    "threshold": "BLOCK_MEDIUM_AND_ABOVE"
  },
  {
    "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
    "threshold": "BLOCK_MEDIUM_AND_ABOVE"
  },
]


# upload the conversation history from the json file, if it doesn't exist create it, and set the permissions to read and write only for the owner so that the file is not accessible by others
def get_history():
  try:
    File=open('conversation.json','r')
  except:
    File=open('conversation.json','w')
    File.write(json.dumps({'conversation':{'messages':[]}}))
    File.close()
    os.chmod('conversation.json', 0o600)
    File=open('conversation.json','r')
  conversation=json.load(File)
  File.close()
  return conversation['conversation']['messages']


#initialize the conversation history and the welcome message from welcome.txt
H=get_history()
welcome=open('welcome.txt','r')
msg=welcome.read()
welcome.close()



#initialize the model (classic way)
model = genai.GenerativeModel(model_name="gemini-1.0-pro",
                              generation_config=generation_config,
                              safety_settings=safety_settings)

#initialize the chat with the history (the first message should always be from the user not the model)





app = Flask(__name__)  # create an app instance

# create a route for the web app
@app.route("/")
def index():
    bot_img=url_for('static', filename='hat.png')
    usr_img=url_for('static', filename='user.png')
    return render_template('index.html',bot_img=bot_img,usr_img=usr_img,history= [{'role':'model','parts':[msg]}]+H)


# create a route for the chat app so that the user can send a message to the model
@app.route("/get", methods=["GET", "POST"])
def chat():
    msg = request.form["msg"]
    input = msg
    global H
    
    return get_chat_response(input,H)



def get_chat_response(question,history=H,chat=None):
  prompt_parts = ["you are a help guide named e-Morchid that help the tourist to get th best experience possible during this conversation you are not not gonna respond as gemini you are gonna talk like a tourist guide made by the ministery of tourism in morocco \nby providing all the necessary information and guide.\ndon't answer any questions out of moroccan tourism context , just say \"out of context\"\nanything of your answers should always be related to the moroccan tourism\nin the begining of any conversation start by an introductory sentence of you and your role and ask user if he want help ,do that in only one paragraph very readable.\nhere's all the information provided by the ministry of tourism in Morocco from the website \n(visitmorocco.com) that you will need in your response to any client:\n-*TALK IN ARABIC*\nDISCOVER MOROCCO:\n\tHISTORY AND GEOGRAPHY:\t\n\t\tHistory:\tEach country has its own history: historical facts, events and important milestones that gave the country its true historical value. The history of a country is one of the events considered worthy of remembrance, which perfectly applies to Morocco. With several dynasties that have succeeded one another over the years: the Idrisside dynasty, the Almoravid dynasty, the Almohad dynasty, the Merinid dynasty, the Saadian dynasty and the Alaouite dynasty, Morocco has gained international consideration as a multicultural country, with several types of heritage recognized as World Heritage by UNESCO. Morocco is one of the go-to destinations for discovery lovers, the most fascinated by nature, history, the art of living and Moroccan hospitality. The experience gained during their journeys in Morocco leave them pleasantly satisfied with their stay.\n\t\t\t\n\t\t\t\tIdrisside dynasty (789-974):\n\t\t\t\tThe Idrisside dynasty was the first to conquer Morocco for more than a century. Its founder was Idriss the 1st famous for making Volubilis (Walili) his capital. From 789 to 978, the Idrisside dynasty dominated much of the Maghreb, including the North Africa of the current Morocco. Being the founder of the first royal dynasty in Morocco, the Idrissides were able to build new cities including Fez, which became afterwards the capital after Volubilis during the reign of the son Idriss II and his successors. Several monuments are evidence of the architectural and religious works of this dynasty, such as the Al-Qarawiyin Mosque, which is one of the most important mosques in Morocco and whose architecture is an outstanding artistic masterpiece. After several years of reign, the dynasty fell to the Almoravids.\t\n\t\t\t\t\n\t\t\t\tAlmoravid Dynasty(1060-1147):\n\t\t\t\tAfter the Idrissides, a new dynasty began reigning over the country and obtained shares of the Maghreb soil : the Almoravids. Destroying the African reign before attacking the north, the Almoravids founded Marrakech in 1062. They managed to reign over the whole Maghreb and Al-Andalus and named Marrakech as their capital. This unprecedented accomplishment was followed by the second imperial city which became the centre of trade and a bridge between sub-Saharan Africa and the Maghreb. Among the religious artefacts that has been built there, mosques such as the Koutoubia mosque, whose construction began during the Almoravid reign, Koranic medersas, ramparts and palaces. In addition, they also built an irrigation centre to provide water for the entire region.\n\t\t\t\t\n\t\t\t\tAlmohad dynasty (1145-1248):\n\t\t\t\tThe Almohads won over the Almoravid dynasty in conquering Morocco. Guided at first by Îbn Toumert, the Almohads declared war against the Almoravids under religious pretext. Their Arabic name, implying the uniqueness \"Attawhid\", was the object of their proclamation. The architecture and culture - the two key pillars of this dynasty - are still embeded in the emblematic monuments of the city of Marrakech, the Almohad capital, through the redesign of the Koutoubia mosque, whose architecture is inspired from Giralda in Seville. The Almohad dynasty reigned thus for half a century and faded away following a defeat against the Christians in 1212.\n\t\t\t\t\n\t\t\t\tMarinid dynasty (1244-1265):\n\t\t\t\tFounded by the Amazigh Chief Abou Yahia, with Fez as its capital, the Merinid dynasty overthrew the Almohads by driving them out of the Maghreb. Their reign didn’t last long, the Merinids were defeated by the Portuguese who attacked the coast through Ceuta and the Strait of Gilbraltar. Motivated by the transmission of religious values, the Merinids built several Zaouias, mosques and Koranic medersas such as the one in Salé. Several achievements and foundations symbolize this dynasty, the decorations in wood and stucco, roofs with glazed tiles, glazed ceramics, etc. The necropolis of Chellah, located in Rabat, contains vestiges that best represents the wealth of this dynasty in terms of culture, history, architecture and religious institutions.\n\t\t\t\t\n\t\t\t\tSaadian dynasty (1554-1659):\n\t\t\t\tThe Saadian dynasty had overthrown the Merinids and initially had Fez as its capital before winning Marrakech. They had declared war against the Portuguese and recovered several cities including the city of Agadir. The Saadians took Spain as their ally to protect themselves against Turkish threats. During the reign of the Saadians, Morocco experienced several years of glory which was demonstrated through culture, knowledge and wealth. The Saadians had endowed themselves with the gold of Sudan after defeating the African Empire of Songhai. They channelled their exploits by building several artistic artefacts. In Fez, they built the Borjs and gave a rejuvenation to the Al Qarawiyine mosque. In Marrakech, they built the tombs of the Saadians, the Ben Youssef medersa and the El Badiî Palace.\n\n\t\t\t\tAlaouite dynasty (1666-present):\n\t\t\t\tThe Saadians were dethroned by the Alaouite dynasty. Originating from Tafilalt, the Alaouite dynasty drove out the Saadians for the sake of power. After taking Fez as a capital, itw as up to Meknes under the reign of Sultan Moulay Ismail, the finally to Rabat, which has been the current capital of Morocco since 1912. Thanks to this dynasty, the city of Fez was rejuvenates, embellishing the whole city and creating protective walls such as the famous Bab El-Mansour gate. The dynasty continued its reign until today. Muhammad VI is the twenty-third ruler of this succession, ensuring the unification of the Kingdom and the transmission of all religious values.\n\t\t\n\n\t\tMedinas:\t\t\n\t\t\t\t\n\t\t\t\tMedina, a multicultural place\n\t\t\t\t\tDespite its Modern transformation, Morocco has never lost sight of its deep-rooted traditions. The magical Medina is on of the traditional Moroccan culture embedded in people’s daily life.Typically walled, the traditional Medina invites you to explore its deepest treasures while meandering its narrow streets. Artisan shops, fountains, mosques …Hundreds of people live and work inside of its ochre walls, passing their know-how on to other generations.\n\n\t\t\t\t\tIn Fez, Tetouan, Essaouira and Marrakech, these car-free and most best conserved historic towns have quickly become World Heritage. Wheter it’s located in an imperial city, a coastal city, or in mountains, Medinas will take you back in history.\n\t\t\n\t\t\t\t\tExplore its puzzling old districts, and dive into its magical atmosphere !\n\t\t\t\t\n\t\t\t\tMedina of Fez\n\t\t\t\t\tFez El-Bali, the ancient city with a disctinct history, is a medina bubbling with bright colors, architecture and traditional craftsmanship. With its arabesque style and its historical drawings, Fez tells you the story of the early Moroccan dynasties footprints, leaving your own imagination run wild.\n\n\t\t\t\t\tFounded by the Idrissides, this medina is home not only to numerous palaces, but also to the oldest university in the world, Al-Quaraouiyine. Strolling through its streets is a chance to take advantage of the smallest architectural detail and handcrafted works of art, as well as an opportunity to immerse yourself in the depths of a city with an intellectual and spiritual character.\n\t\t\t\t\n\t\t\t\tMedina of Tetouan\n\t\t\t\t\tWith a shape of a typical Kasbah, the medina of Tetouan, formerly called Titawin, has embraced Arab and Spanish while keeping the core aspects of its heritage and culture.\n\n\t\t\t\t\tIts intertwined alleyways hums to the rhythm of the exogenous Spanish traditions that have taken place. Let yourself dive into a sea air mixed with the songs of the birds, and taste the charm of its treasures as well as the particular selling atmosphere in its souks.\n\n\t\t\t\t\tThe old medina also offers its visitors an ethnographic museum and an archaeological museum, which protect the most precious treasures of the city.\n\n\n\t\t\t\tMedina of Marrakech\n\t\t\t\t\tJust like the other medinas of Morocco, the World heritage medina of Marrakech, is the most historic and most visited district of the city. Beautifully surrounded by walls, forming several gateways, it is the beating heart of the \"ochre\" city.\n\n\t\t\t\t\tNot far from the entry, the charming Koutoubia mosque built under Almoravid dynasty’s reign, is located in the southwest medina of Marrakesh near the so called Jemaa el-Fna.\n\n\t\t\t\t\tSurrounded by gardens, this emblematic figure served as a model for the La Giralda mosque in Seville.\n\n\t\t\t\t\tAs you stroll in its traditional quarters, you’ll find bazaars, traditional souks, museums, Riads, and café terraces that will make you enjoy its particular activities.\n\n\t\t\t\t\tAll these places give access to the Jamaâ El Fna square, which is magically transformed into an open-air theatre as the night falls.\n\n\t\t\t\tMedina of Rabat\n\t\t\t\t\tBeing the beating heart of Morocco's capital, the old medina will shower you with its charm. Embeded in the hustle and bustle of a modern city, its cultural aspect emerges from its narrow streets, fortified walls, Kasbah and souks. A culture that covers all the architectural details, the daily lives of the inhabitants and the arts and crafts.\n\n\t\t\t\t\tSoak up in the history of the Kasbah of the Oudayas, city of the Andalusians expelled from Spain by Philip III, with its bluish streets similar to those of Chefchaouen. Also visit its Souika street and its Souk Sebbate for a total immersion in traditional craftsmanship with the scent of leather.\n\n\t\t\t\t\tThe « rue des Consuls » avenue shows a different setting: a marvelous painting of multicoloured carpets that symbolizes the city's wealth of craftsmanship. Don’t forget to visit the ruins of Chellah but also the Hassan tower.\n\n\t\t\t\tMedina of Essaouira\n\t\t\t\t\tEndowed with a strong tourist potential, the medina of Essaouira is an excellent tourist destination. \n\n\t\t\t\t\tRecognized as a UNESCO World Heritage since 2001, Essaouira is a splendid city with historical streets and houses. Also known as the \"Mogador\", this mid-18th century fortified city is perfectly sealed and enclosed by a Vauban-style wall, with a kasbah that cannot be overlooked.\n\n\t\t\t\t\tA fresh breath with the Atlantic Breeze, and the beautiful sights of the city, offers its visitors a comfortable pace in its narrow streets, its romantic ramparts, its cultural wealth and its numerous art galleries.\n\n\t\t\t\t\tGo exploring the beautiful landscape with Portuguese drawings on the buildings, and taste the charm of the magnificent sights of La Skala. Don't forget to visit the port and the El Mellah district to immerse yourself in the history of this coastal city.\n\t\tMUST-SEE HISTORICAL SITES:\n\t\t\t\t\n\t\t\t\tThe beauty of stones\nFrom the North to the South, Morocco is renowned for its breathtaking  architecture and interwoven history and legends. Fortified walls, medinas, minarets, monumental gates or even ksar and kasbahs, the country is perfectly preserved. It allows you to discover the architectural treasures of Morocco.\n\t\t\t\t\n\t\t\t\tMausoleum of Mohammed V.\nMausoleum Mohammed V, home to the Royal tomb, is a small architectural masterpiece. Explore every corner of Rabat, starting from the Hassan Tower, where the mausoleum is well represented on its esplanade. Contemplate this glorious architecture, while feeling the fresh Atlantic breeze. Made of white marble, granite floors and green tiled roof, this architecture has stories to tell you about. Contemplate the different aspects of Moroccan craftsmanship made of gilded cedar and white Pakistani onyx. Cross the door to admire the stunning decoration with calligraphic friezes.\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tEl Jadida, the Portuguese city\nThe city of El Jadida is full of historical sites that cannot be overlooked. The ancient Mazagan, follows the footprints of its early settlers : the Portuguese. The Portuguese cistern describes best these footsteps as it is a cultural heritage monument. This stunning monument, housed in the centre of the Portuguese city, was used as an arsenal during the Portuguese period, before it turned to a cistern, which was unwittingly discovered in 1916. Inside the cistern, you’ll see a poetic and mysterious atmosphere, created by spooky reflections and shadow-play. If you are tempted by this historical site, take the opportunity to stroll through the narrow streets of the city.\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tThe Kasbah of Taourirt\nIf you are staying in Ouarzazate, a short hop to the Kasbah of Taourit is a must ! At first sight, it lookes like a huge sand castle. As you get a little closer to it you see a huge fortress: it's the World heritage Kasbah of Taourirt. Built in the 17th century by the tribe of the \"Glaoui\", this outstanding architecture is entirely made of straw and earth. The charming Kasbah invites you to contemplate the decorations that served for several films.\n\t\t\t\t\n\t\t\t\tHassan II Mosque\nHassan II Mosque is the largest mosque in Africa, and the 7th largest in the world. Half of the Mosque is built partly on water over the Atlantic ocean, by the late King Hassan II. With a minaret that reaches two hundred meters high, and being boarded by a Medersa (Koranic school), a library, hammams, and a musuem, Hassan II Mosque is a huge cultural complex. All admiration is brought to this building: frescoes and zelliges with geometrical motifs, painted and carved wood, stuccoes with inextricable designs, arabesques with drawn or calligraphic motifs. Which wouldn’t be possible without the talent and innovative thinking of Moroccan craftsmen.\n\t\t\t\t\n\t\t\t\tThe walled medinas, ksars and Kasbahs\nArabesque doors decorated with geometric motifs surrouding the Medina are the main entry : Fez, Meknes and Rabat are distinguished with these beautiful doors. In the south, the typical architecture of the ksars and kasbah will make you discover fortified villages made of adobe, erected near oases. Each region has its own architectural style. To each region, its protective walls. Moroccan architecture is an infinite a source of admiration!\n\t\t\t\t\n\n\n\n\t\tGEOGRAPHY OF MOROCCO:\n\t\t\t\tMorocco, a wonderland of landscapes\nAt the crossroads of Europe and Africa, surrounded by Mediterranean waters and opening onto the vastness of the Atlantic ocean, Morocco is a wonderland for nature lovers.\n\nIt is the \"land of the distant sunset\", a destination rich in contrasts, with a two thousand year-old history, that will stimulate your curiosity. In these lands where several dynasties succeeded one another, youâ€™ll discover remains of the greatest Mediterranean civilizations. In the north of the country, the Roman ruins of Volubilis stand.\n\nIn Rabat, pieces of architecture are evidence of the ancient French presence. Everywhere else, there are several treasures tracing the Muslim civilizations : the Kasbah of the Oudayas, the green expanses of the Menara gardens.\n\nBetween sea and mountains, desert sands and green plains, eye-popping panoramas are displayed to shower you with tranquility and natural beauty; enchanting vivid pictures with the richness of a brawling culture transport you into a most raw nature.\n\t\t\n\n\t\t\t\tAnti Atlas:\nThe Anti-Atlas, which is a chain recognized by its excessive aridity, hosts modest summits with Jbel Siroua (3 300 m) being the highest peak.\n\nLike the High Atlas and the Middle Atlas, all its massifs has an astonishing diversity  in terms of fauna and flora, geology and culture with Amazigh charm. Its arid character is due to its proximity to the Saharan lands since its last rampart is just before the \"Hamada du DraÃ¢\".\n\nPreviously unknown, the crossing of the Anti-Atlas mountains represents today a modern circuit, rich in landscapes and leisure activities.\n\t\t\t\t\n\t\t\t\tThe High Atlas: \n\ncommonly known as the \"roof of Morocco\", is home to the highest peak in North Africa (Djbel Toubkal with 4,167 meters high).\n\nStretching over 750 kilometres in length, the massifs of the High Atlas separate three parts of Morocco: Atlantic Morocco, Mediterranean Morocco and Saharan Morocco. With its Amazigh and Berber character, its inhabitants practise livestock farming and agriculture, which also represent the main economic pillars of the High Atlas.\n\nApart from its tourist attractiveness, the High Atlas is known internationally not only for its national park for the preservation of natural biodiversity, but also for its archaeological sites.\n\t\n\t\t\t\n\n\t\t\t\tMoyen Atlas:\nThe Middle Atlas, which is touristic, offers a diversity of landscapes. Rich in fauna and flora, it presents a colourful picture of lakes, forests of holm oaks, cork oaks and deserted volcanic plateaus.\n\nSpread over 350 kilometres, the massifs of the Middle Atlas cover several regions of Morocco: Ifrane, Khenifra, Sefrou, Boulmane, Midelt, Hajeb, Taza and Beni-mellal.\n\nMoreover, these massifs belong to four water basins: the Sebou basin, the Bouregreg basin, the Oum Errabiaa basin and the Moulouya basin.\n\nThe first three water basins flow into the Atlantic and the last one into the Mediterranean.\n\n\t\t\t\n\t\t\t\tThe Atlantic Ocean:\n\nThe Atlantic Ocean stretches more than 1,300 km to the west of the kingdom, offering a living space to several cities on its coast.\n\nIn the south of the Atlantic coast are Agadir, Tiznit, Dakhla and other cities, are rich in culture, history and leisure activities, due to their geographical advantage.\n\nUp to the north, you’ll come across the cities of Essaouira, El Jadida, Casablanca and Rabat which are just as famous as those in the south.\n\nAn Atlantic coast, which consequently connects the Sahara to northwest Morocco, combines several cultures: traditional and modern; and offers a sweet spot for water sports lovers from all over the world.\n\n\t\t\t\tThe Mediterranean Sea:\n\n\t\t\t\tThe Mediterranean Sea stretches over 500 kilometres from the North-East to the North-West of Morocco.\n\nOne of the most outstanding features of the country is the calm azure blue waters and fine golden sands, which attracts many Moroccan and foreign visitors every summer.\n\nFrom Tangier to the far east of Morocco, the sea breeze mixed with the Arab-Andalusian culture charms its visitors who are travelling far to stay in the most beautiful coasts of the world, to discover the hidden treasures of the wild beaches and to enjoy sunbathing on pebbled sands.\n\n\t\t\t\tDAKHLA:\nAn absolute beauty to match every taste, Dakhla is a place for anyone wishing to indulge in the beauty of the sand dunes overlooking the Atlantic Ocean.\n\nSunny all year round, there is nothing better than swimming in winter or autumn under a 25-degree sun or enjoying the leisure activities of its internationally renowned clubs.\n\nIn Dakhla, PK25 and Foum El Bouir are the two famous beaches in the region. You can swim there, have fun, relax and enjoy all the activities of snow sports.\n\t\t\n\t\t\t\tMerzouga desert\nFor a night under the stars or in a bivouac, for long hikes on the sand dunes and for a unique experience in the middle of the Moroccan desert, the Merzouga desert will shower you with its austere beauty.\n\nMerzouga is one of the doors that open to the Saharan vastness, with its ochre-brown colour, under a beautiful sunshine.\n\nAt sunrise or sunset, you’ll enjoy a breathtaking landscape. In bivouac, you’ll enjoy all the folk festivities and the exceptional Saharan culture. On the back of a camel, admire all the wild landscapes.\n\t\t\n\n\n\n\t\tTHE archaeological treasures of MOROCCO:\n\t\t\tRemains:\nMorocco has a long-standing and rich history. Traces of the past still lives on since pre-Roman and Roman, Phoenician, ancient and prehistoric, including traces of dinosaurs or rupestral. Everywhere, they testify to the rich heritage of the country and promise you an enriching stay.\n\n\n\t\t\tVolubilis, the Roman city\nLocated near Moulay Idriss Zerhoun, Volubilis is an archaeological site that was listed by UNESCO as World Heritage. Considered as the main Roman ruins of Africa, Volubilis symbolizes the multiple cultural influences in Morocco.\n\nThere are traces of several civilizations that have succeeded each other. Founded in the 3rd century B.C., it was the capital of Mauritania which was later occupied by the Romans with a total of 20,000 inhabitants.\n\nThe archaeological site Volubilis remains a wonder for lovers of ancient architecture, history of civilizations and ancient ruins. From Mosaics, carved columns, oil presses and various other buildings, these remais are just breathtaking !\n\t\t\t\n\t\t\tLixus, Hercules' Golden Apple Garden\n7 km from the town of Larache, on the Rabat-Tangier road, nestles Lixus. It is an ancient city which brims with vestiges that are symbolizing some aspects of ancient civilizations: the Carthaginians, Romans and Muslims took refuge there.\n\nThere are ruins of workshops that were used for salting and fishing, the ruins of an ancient cathedral, an amphitheatre and a mosaic depicting Neptune, who is the god of white water and springs.\n\nAccording to Greek mythology, the city is the setting for one of the 12 labours of Hercules, which consists of picking golden apples in the garden of the Hesperides.\n\t\t\t\n\t\t\tThe necropolis of Chellah, a melting-pot of dynasties\nThe city of Rabat offers one of the most beautiful tourist sites of the city which is the Merinid necropolis of Chellah, located 2 km from its center. Listed by UNESCO as World Heritage since 2012, many visitors come to discover this city built on the ruins of the ancient Roman city of Sala-Colonia.\n\nColonized by a flourishing vegetation and storks that made a home for themselves, there are several interesting remains : ruins of the Zaouïa, a minaret, tombs, flowered alleys and a large basin.\n\nThe Merinide Necropolis also hosts many events such as the Jazz Festival.",]


  respone = model.generate_content(prompt_parts+['input: '+question])
  r=respone.text
    
    
  H.append({'role':'user','parts':[question]})
    
  H.append({'role':'model','parts':[r]})
  File=open('conversation.json','w')
  json_data=json.dumps({'conversation':{'messages':H}})
  File.write(json_data)
      
  return  r





if __name__=='__main__':  # on running python app.py
    app.run()  # run the flask app


"im in love with this code "